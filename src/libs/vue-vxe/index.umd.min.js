!function(e,t){"function"==typeof define&&define.amd?define("vxe-table-plugin-virtual-tree",[],t):"undefined"!=typeof exports?t():(t(),e.VXETablePluginVirtualTree={}.default)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(){"use strict";!function(e,t){"function"==typeof define&&define.amd?define("vxe-table-plugin-virtual-tree",["exports","xe-utils/ctor"],t):"undefined"!=typeof exports?t(exports,require("xe-utils/ctor")):(t(t={},e.ctor),e.vxeTablePluginVirtualTree=t)}(void 0,function(e,E){var m=function(e,t){for(var n=0,r=t.length,i=e.length;n<r;n++,i++)e[i]=t[n];return e};function x(e,t){e=t[e.treeOpts.children];return e&&e.length}function t(e){var t=e.setup,c=e.t,b=t(),r=Object.keys(e.Table.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)}),t={name:"VxeVirtualTree",extends:e.Grid,data:function(){return{removeList:[],treeLazyLoadeds:[]}},computed:{treeOpts:function(){return Object.assign({},b.table.treeConfig,this.treeConfig)},checkboxOpts:function(){return Object.assign({},b.table.checkboxConfig,this.checkboxConfig)},tableExtendProps:function(){var t=this,n={};return r.forEach(function(e){n[e]=t[e]}),n.checkboxConfig&&(n.checkboxConfig=this.checkboxOpts),n}},watch:{columns:function(e){this.handleColumns(e)},data:function(e){this.loadData(e)}},created:function(){var e=this.$vxe,t=this.treeOpts,n=this.data,r=this.columns;Object.assign(this,{fullTreeData:[],treeTableData:[],fullTreeRowMap:new Map}),this.keepSource&&console.error(e.t("vxe.error.notProp",["keep-source"])),t.line&&console.error(e.t("vxe.error.notProp",["checkbox-config.line"])),r&&this.handleColumns(r),n&&this.reloadData(n)},render:function(e){var t,n,r,i,a,o,s,l,c,h,u,d,f=this.vSize,p=this.isZMax,x=this.$scopedSlots,g=!(!x.form&&!this.formConfig),T=!!(x.toolbar||this.toolbarConfig||this.toolbar),v=!(!x.pager&&!this.pagerConfig);return e("div",{class:["vxe-grid","vxe-virtual-tree",((u={})["size--"+f]=f,u["t--animat"]=!!this.animat,u["is--round"]=this.round,u["is--maximize"]=p,u["is--loading"]=this.loading||this.tableLoading,u)],style:this.renderStyle},[g?e("div",{ref:"formWrapper",staticClass:"vxe-grid--form-wrapper"},x.form?x.form.call(this,{$grid:this},e):(l=e,f=(c=this).proxyConfig,p=c.proxyOpts,u=c.formData,g=c.formConfig,d=c.formOpts,g&&d.items&&d.items.length?(d.inited||(d.inited=!0,h=p.beforeItem,p&&h&&d.items.forEach(function(e){h.call(c,{$grid:c,item:e})})),[l("vxe-form",{props:Object.assign({},d,{data:f&&p.form?u:d.data}),on:{submit:c.submitEvent,reset:c.resetEvent,"submit-invalid":c.submitInvalidEvent,"toggle-collapse":c.togglCollapseEvent},ref:"form"})]):[])):null,T?e("div",{ref:"toolbarWrapper",class:"vxe-grid--toolbar-wrapper"},x.toolbar?x.toolbar.call(this,{$grid:this},e):[e("vxe-toolbar",{props:this.toolbarOpts,ref:"xToolbar",scopedSlots:(d=(a=this).$scopedSlots,T=a.toolbarOpts.slots,a={},T&&(o=T.buttons,s=T.tools,o&&d[o]&&(o=d[o]),s&&d[s]&&(s=d[s])),o&&(a.buttons=o),s&&(a.tools=s),a)})]):null,x.top?e("div",{ref:"topWrapper",staticClass:"vxe-grid--top-wrapper"},x.top.call(this,{$grid:this},e)):null,e("vxe-table",{props:this.tableProps,on:(o=(r=this).$listeners,s=r.proxyConfig,a=r.proxyOpts,i={},E.default.each(o,function(e,n){i[n]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];r.$emit.apply(r,m([n],e))}}),i["checkbox-all"]=r.checkboxAllEvent,i["checkbox-change"]=r.checkboxChangeEvent,s&&(a.sort&&(i["sort-change"]=r.sortChangeEvent),a.filter&&(i["filter-change"]=r.filterChangeEvent)),i),scopedSlots:x,ref:"xTable"}),x.bottom?e("div",{ref:"bottomWrapper",staticClass:"vxe-grid--bottom-wrapper"},x.bottom.call(this,{$grid:this},e)):null,v?e("div",{ref:"pagerWrapper",staticClass:"vxe-grid--pager-wrapper"},x.pager?x.pager.call(this,{$grid:this},e):[e("vxe-pager",{props:this.pagerProps,on:{"page-change":this.pageChangeEvent},scopedSlots:(x=(v=this).$scopedSlots,e=v.pagerOpts.slots,v={},e&&(t=e.left,n=e.right,t&&x[t]&&(t=x[t]),n&&x[n]&&(n=x[n])),t&&(v.left=t),n&&(v.right=n),v)})]):null])},methods:{loadColumn:function(n){var a=this;return this.$nextTick().then(function(){var r=a.$vxe,i=a.$scopedSlots,t=a.renderTreeIcon,e=a.treeOpts;E.default.eachTree(n,function(e){e.treeNode&&(e.slots||(e.slots={}),e.slots.icon=t),e.slots&&E.default.each(e.slots,function(e,t,n){E.default.isFunction(e)||(i[e]?n[t]=i[e]:(n[t]=null,console.error(r.t("vxe.error.notSlot",[e]))))})},e),a.$refs.xTable.loadColumn(n)})},renderTreeIcon:function(t,e,n){var r=this,i=this.treeLazyLoadeds,a=this.treeOpts,o=t.isHidden,s=t.row,l=a.children,c=a.hasChild,h=a.indent,u=a.lazy,d=a.trigger,f=a.iconLoaded,p=a.showIcon,x=a.iconOpen,g=a.iconClose,T=s[l],v=!1,E=!1,a=!1,l={};return o||(E=s._X_EXPAND,u&&(a=-1<i.indexOf(s),v=s[c])),d&&"default"!==d||(l.click=function(e){return r.triggerTreeExpandEvent(e,t)}),[e("div",{class:["vxe-cell--tree-node",{"is--active":E}],style:{paddingLeft:s._X_LEVEL*h+"px"}},[p&&(T&&T.length||v)?[e("div",{class:"vxe-tree--btn-wrapper",on:l},[e("i",{class:["vxe-tree--node-btn",a?f||b.icon.TABLE_TREE_LOADED:E?x||b.icon.TABLE_TREE_OPEN:g||b.icon.TABLE_TREE_CLOSE]})])]:null,e("div",{class:"vxe-tree-cell"},n)])]},_loadTreeData:function(e){var t=this,n=this.getRadioRecord();return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)}).then(function(){n&&t.setRadioRow(n)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){return this.setTreeExpand(e,t)},handleAsyncTreeExpandChilds:function(n){var r=this,i=this.treeLazyLoadeds,e=this.treeOpts,t=this.checkboxOpts,a=e.loadMethod,o=e.children,s=t.checkStrictly;return new Promise(function(t){a?(i.push(n),a({row:n}).catch(function(){return[]}).then(function(e){n._X_LOADED=!0,E.default.remove(i,function(e){return e===n}),(e=!E.default.isArray(e)?[]:e)&&(n[o]=e.map(function(e){return e._X_LOADED=!1,e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=n._X_LEVEL+1,e}),e.length&&!n._X_EXPAND&&r.virtualExpand(n,!0),!s&&r.isCheckedByCheckboxRow(n)&&r.setCheckboxRow(e,!0)),t(r.$nextTick().then(function(){return r.recalculate()}))})):t(null)})},setTreeExpand:function(t,n){var r=this,i=this.treeLazyLoadeds,e=this.treeOpts,a=this.tableFullData,o=this.treeNodeColumn,s=e.lazy,l=e.hasChild,c=e.accordion,h=e.toggleMethod,u=[];if(t){E.default.isArray(t)||(t=[t]);var d=this.getColumnIndex(o),f=this.getVMColumnIndex(o),p=h?t.filter(function(e){return h({expanded:n,column:o,row:e,columnIndex:d,$columnIndex:f})}):t;return c&&(p=p.length?[p[p.length-1]]:[],(e=E.default.findTree(a,function(e){return e===t[0]},e))&&e.items.forEach(function(e){e._X_EXPAND=!1})),p.forEach(function(e){var t=s&&e[l]&&!e._X_LOADED&&-1===i.indexOf(e);n&&t?u.push(r.handleAsyncTreeExpandChilds(e)):x(r,e)&&r.virtualExpand(e,!!n)}),Promise.all(u).then(function(){return r._loadTreeData(r.treeTableData),r.recalculate()})}return this.$nextTick()},setAllTreeExpansion:function(e){return this.setAllTreeExpand(e)},setAllTreeExpand:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this.toggleTreeExpand(e)},triggerTreeExpandEvent:function(e,t){var n=this.treeOpts,r=this.treeLazyLoadeds,i=t.row,t=t.column;n.lazy&&-1!==r.indexOf(i)||(r=!this.isTreeExpandByRow(i),this.setTreeExpand(i,r),this.$emit("toggle-tree-expand",{expanded:r,column:t,row:i,$event:e}))},toggleTreeExpand:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this,e=this.fullTreeData,n=this.treeOpts,r=[];return E.default.eachTree(e,function(e){e._X_EXPAND&&x(t,e)&&r.push(e)},n),r},clearTreeExpand:function(){return this.setAllTreeExpand(!1)},handleColumns:function(e){var t=this.$vxe,n=this.renderTreeIcon,r=this.checkboxOpts;if(e){if((!r.checkField||!r.halfField)&&e.some(function(e){return"checkbox"===e.type}))return console.error(t.t("vxe.error.reqProp",["table.checkbox-config.checkField | table.checkbox-config.halfField"])),[];r=e.find(function(e){return e.treeNode});return r&&((t=r.slots||{}).icon=n,r.slots=t,this.treeNodeColumn=r),e}return[]},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:[]}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var e=this.treeOpts,t=[];return E.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},e),t},insert:function(e){return this.insertAt(e,null)},insertAt:function(e,t){var n=this,r=this.fullTreeData,i=this.treeTableData,a=this.treeOpts,o=(e=!E.default.isArray(e)?[e]:e).map(function(e){return n.defineField(Object.assign({_X_LOADED:!1,_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)r.push.apply(r,o),i.push.apply(i,o);else{var s=E.default.findTree(r,function(e){return e===t},a);if(!s||-1===s.index)throw new Error(c("vxe.error.unableInsert"));var e=s.items,a=s.index,l=s.nodes,s=i.indexOf(t);-1<s&&i.splice.apply(i,m([s,0],o)),e.splice.apply(e,m([a,0],o)),o.forEach(function(e){e._X_LEVEL=l.length-1})}else r.unshift.apply(r,o),i.unshift.apply(i,o);return this._loadTreeData(i).then(function(){return{row:o.length?o[o.length-1]:null,rows:o}})},getRemoveRecords:function(){return this.removeList},removeSelecteds:function(){return this.removeCheckboxRow()},removeCheckboxRow:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearSelection(),e})},remove:function(e){var o=this,s=this.removeList,l=this.fullTreeData,c=this.treeOpts,h=[];return e?E.default.isArray(e)||(e=[e]):e=l,e.forEach(function(t){var e,n,r,i,a=E.default.findTree(l,function(e){return e===t},c);a&&(e=a.item,n=a.items,r=a.index,i=a.parent,o.isInsertByRow(t)||s.push(t),i?((a=o.isTreeExpandByRow(i))&&o.handleCollapsing(i),n.splice(r,1),a&&o.handleExpanding(i)):(o.handleCollapsing(e),n.splice(r,1),o.treeTableData.splice(o.treeTableData.indexOf(e),1)),h.push(e))}),this._loadTreeData(this.treeTableData).then(function(){return{row:h.length?h[h.length-1]:null,rows:h}})},handleDefaultTreeExpand:function(){var r,e,i,a=this,t=this.treeConfig,o=this.treeOpts,s=this.tableFullData;t&&(r=o.children,e=o.expandAll,t=o.expandRowKeys,e?this.setAllTreeExpand(!0):t&&this.rowId&&(i=this.rowId,t.forEach(function(t){var e=E.default.findTree(s,function(e){return t===E.default.get(e,i)},o),n=e?e.item[r]:0;n&&n.length&&a.setTreeExpand(e.item,!0)})))},toVirtualTree:function(e){var t=this.treeOpts,o=this.fullTreeRowMap;return o.clear(),E.default.eachTree(e,function(e,t,n,r,i,a){e._X_LOADED=!1,e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1,o.set(e,{item:e,index:t,items:n,paths:r,parent:i,nodes:a})},t),this.fullTreeData=e.slice(0),this.treeTableData=e.slice(0),e},virtualExpand:function(e,t){var n=this.treeOpts,r=this.treeNodeColumn,i=n.toggleMethod,a=this.getColumnIndex(r),n=this.getVMColumnIndex(r);return i&&!i({expanded:t,row:e,column:r,columnIndex:a,$columnIndex:n})||e._X_EXPAND!==t&&(e._X_EXPAND?this.handleCollapsing(e):this.handleExpanding(e)),this.treeTableData},handleExpanding:function(e){if(x(this,e)){var t=this.treeTableData,n=this.treeOpts,r=e[n.children],o=[],i=t.indexOf(e);if(-1===i)throw new Error("Expanding error");var s=new Map;E.default.eachTree(r,function(e,t,n,r,i,a){(!i||i._X_EXPAND&&s.has(i))&&(s.set(e,1),o.push(e))},n),e._X_EXPAND=!0,t.splice.apply(t,m([i+1,0],o))}return this.treeTableData},handleCollapsing:function(e){var t,n,r,i;return x(this,e)&&(t=this.treeTableData,r=e[(n=this.treeOpts).children],i=[],E.default.eachTree(r,function(e){i.push(e)},n),e._X_EXPAND=!1,this.treeTableData=t.filter(function(e){return-1===i.indexOf(e)})),this.treeTableData},virtualAllExpand:function(t){var n,e=this.treeOpts;return t?(n=[],E.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND=t,n.push(e)},e),this.treeTableData=n):(E.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND=t},e),this.treeTableData=this.fullTreeData.slice(0)),this.treeTableData},checkboxAllEvent:function(e){var t=this.checkboxOpts,n=this.treeOpts,r=t.checkField,i=t.halfField,t=t.checkStrictly,a=e.checked;r&&!t&&E.default.eachTree(this.fullTreeData,function(e){e[r]=a,i&&(e[i]=!1)},n),this.$emit("checkbox-all",e)},checkboxChangeEvent:function(e){var t=this.checkboxOpts,n=this.treeOpts,r=t.checkField,i=t.halfField,a=t.checkStrictly,t=e.row,o=e.checked;r&&!a&&(E.default.eachTree([t],function(e){e[r]=o,i&&(e[i]=!1)},n),this.checkParentNodeSelection(t)),this.$emit("checkbox-change",e)},checkParentNodeSelection:function(t){var e=this.checkboxOpts,n=this.treeOpts,r=n.children,i=e.checkField,a=e.halfField,e=e.checkStrictly,n=E.default.findTree(this.fullTreeData,function(e){return e===t},n);n&&i&&!e&&((e=n.parent)?(n=e[r].every(function(e){return e[i]}),a&&!n&&(e[a]=e[r].some(function(e){return e[i]||e[a]})),e[i]=n,this.checkParentNodeSelection(e)):this.$refs.xTable.checkSelectionStatus())},getCheckboxRecords:function(){var e=this.checkboxOpts,t=this.treeOpts,n=e.checkField;if(n){var r=[];return E.default.eachTree(this.fullTreeData,function(e){e[n]&&r.push(e)},t),r}return this.$refs.xTable.getCheckboxRecords()},getCheckboxIndeterminateRecords:function(){var e=this.checkboxOpts,t=this.treeOpts,n=e.halfField;if(n){var r=[];return E.default.eachTree(this.fullTreeData,function(e){e[n]&&r.push(e)},t),r}return this.$refs.xTable.getCheckboxIndeterminateRecords()}}};e.Vue.component(t.name,t)}Object.defineProperty(e,"__esModule",{value:!0}),e.VXETablePluginVirtualTree=void 0,e.VXETablePluginVirtualTree={install:function(e){t(e)}},"undefined"!=typeof window&&window.VXETable&&window.VXETable.Table&&window.VXETable.use(e.VXETablePluginVirtualTree),e.default=e.VXETablePluginVirtualTree})});